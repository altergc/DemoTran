scale_y_continuous(name="rate" )
df2 <- df1[df1$Country=='China',c(1, 2, 3, 4, 5, 6, 7 ) ] %>%
mutate(RNI_5 = rollmean(RNI, k=5, fill=NA, align='right'),
RNI_9 = rollmean(RNI, k=9, fill=NA, align='right'),
RNI_11 = rollmean(RNI, k=11, fill=NA, align='right'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='right'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='right')
)
df2 <- subset(df2, !is.na(Year))
df2$year <- as.numeric(df2$Year)
########################################################
ggplot(df2, mapping=aes(x=Year )) +
geom_line( aes(y=CDR_MAV, color="CDR11" , group=1) ) +
geom_line( aes(y=CBR_MAV, color="CBR11" , group=1 ) ) +
geom_line( aes(y=RNI_11, color="RNI11" , group=1) ) +
scale_x_discrete(name="Years",  breaks = ~ .x[seq(1, length(.x), 20)] )+
scale_y_continuous(name="RNI",  breaks = c(-20, -10, 0, 5, 10 , 15, 20, 25, 30, 35, 40, 45) ) +
scale_color_manual(values=c("red", "blue", "darkgreen"))
fit.lm <- lm(CDR ~ year, data=df2 )
fit.seg <- segmented(fit.lm, seg.Z=~year, npsi=2)
summary(fit.seg)
df2$psCDR <- predict(fit.seg)
summary(df2$CDR)
summary(df2$psCDR)
ggplot(df2, mapping=aes(x=year )) +
geom_point( aes(y=CDR, color="CDR" , group=1 ) ) +
geom_line( aes(y=psCDR, color="psCDR" , group=1) ) +
scale_y_continuous(name="rate" )
fit.lm <- lm(CBR ~ year, data=df2 )
fit.seg <- segmented(fit.lm, seg.Z=~year, npsi=2)
summary(fit.seg)
df2$psCBR <- predict(fit.seg)
summary(df2$CBR)
summary(df2$psCBR)
ggplot(df2, mapping=aes(x=year )) +
geom_point( aes(y=CBR, color="CBR" , group=1 ) ) +
geom_line( aes(y=psCBR, color="psCBR" , group=1) ) +
scale_y_continuous(name="rate" )
df2 <- df1[df1$Country=='Taiwan',c(1, 2, 3, 4, 5, 6, 7 ) ] %>%
mutate(RNI_5 = rollmean(RNI, k=5, fill=NA, align='right'),
RNI_9 = rollmean(RNI, k=9, fill=NA, align='right'),
RNI_11 = rollmean(RNI, k=11, fill=NA, align='right'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='right'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='right')
)
df2 <- subset(df2, !is.na(Year))
df2$year <- as.numeric(df2$Year)
ggplot(df2, mapping=aes(x=Year )) +
geom_line( aes(y=CDR_MAV, color="CDR11" , group=1) ) +
geom_line( aes(y=CBR_MAV, color="CBR11" , group=1 ) ) +
geom_line( aes(y=RNI_11, color="RNI11" , group=1) ) +
scale_x_discrete(name="Years",  breaks = ~ .x[seq(1, length(.x), 20)] )+
scale_y_continuous(name="RNI",  breaks = c(-20, -10, 0, 5, 10 , 15, 20, 25, 30, 35, 40, 45) ) +
scale_color_manual(values=c("red", "blue", "darkgreen"))
fit.lm <- lm(CDR ~ year, data=df2 )
fit.seg <- segmented(fit.lm, seg.Z=~year, npsi=2)
summary(fit.seg)
df2$psCDR <- predict(fit.seg)
summary(df2$CDR)
summary(df2$psCDR)
ggplot(df2, mapping=aes(x=year )) +
geom_point( aes(y=CDR, color="CDR" , group=1 ) ) +
geom_line( aes(y=psCDR, color="psCDR" , group=1) ) +
scale_y_continuous(name="rate" )
fit.lm <- lm(CBR ~ year, data=df2 )
fit.seg <- segmented(fit.lm, seg.Z=~year, npsi=2)
summary(fit.seg)
df2$psCBR <- predict(fit.seg)
summary(df2$CBR)
summary(df2$psCBR)
ggplot(df2, mapping=aes(x=year )) +
geom_point( aes(y=CBR, color="CBR" , group=1 ) ) +
geom_line( aes(y=psCBR, color="psCBR" , group=1) ) +
scale_y_continuous(name="rate" )
library("readxl")
df0 = readexcel("C:\Users\altergc\Documents\Historical Demography\Handbook\Data\WorldBank\WorldBank_B-D.xlsx")
df0 = readexcel("C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.xlsx")
df0 = read_excel("C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.xlsx")
names(df0)
df1 <- pivot_longer(df0, names_to=c(""Series Name", "Series Code", "Country Name", "Country Code""), values_to="Rate")
df1 <- pivot_longer(df0, names_to=c("Series Name", "Series Code", "Country Name", "Country Code""), values_to="Rate")
df0 >%> pivot_longer( names_to=c("Series Name", "Series Code", "Country Name", "Country Code""), values_to="Rate")
df1 <- pivot_longer(df0,
names_to=c("Series Name", "Series Code", "Country Name", "Country Code""),
values_to="Rate")
df1 <- pivot_longer(df0,
names_to=c("Series Name", "Series Code", "Country Name", "Country Code"),
values_to="Rate")
library("tidyr")
df1 <- pivot_longer(df0,
names_to=c("Series Name", "Series Code", "Country Name", "Country Code"),
values_to="Rate")
df0 <- read_excel("C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.xlsx",
sheet="revised")
names(df0)
View(df0)
View(df0)
nn0 <- names(df0)
nn0[5]
nn0[69]
nn0[68]
nn0[5:68]
nn0 <- names(df0)
df1 <- pivot_longer(df0, cols=nn0[5:68],
names_to=c("Series Name", "Series Code", "Country Name", "Country Code"),
values_to="Rate")
df1 <- pivot_longer(df0, cols=nn0[5:68],
values_to="Rate")
df1 <- pivot_longer(df0[, -c(69:75)], cols=nn0[5:68],
values_to="Rate")
df2$year <- integer(df1$name)
df2 <- cbind(df1, year= integer(df1$name) )
length(df1$name)
length(df1)
length(df1$Country)
cbind(df1, year= integer(df1$name) )
cbind(df1, year= integer(df1['name']) )
cbind(df1, year= as.integer(df1$name) )
df2 <- cbind(df1, year= as.integer(df1$name) )
df2$Rate <- as.numeric(df2$Rate)
save(df2, "C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.Rda")
save(df2, file="C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.Rda")
df3 <-load("C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.Rda")
load("~/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.Rda")
library("readxl")
library("tidyr")
df0 <- read_excel("C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.xlsx",
sheet="revised")
nn0 <- names(df0)
df1 <- pivot_longer(df0[, -c(69:75)], cols=nn0[5:68],
values_to="Rate")
WBdat <- cbind(df1, year= as.integer(df1$name) )
WBdat$Rate <- as.numeric(WBdat$Rate)
save(WBdat, file="C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.Rda")
load("C:/Users/altergc/Documents/Historical Demography/Handbook/Data/WorldBank/WorldBank_B-D.Rda")
View(WBdat)
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
#######  read country-region list here ####################################
####### 'df1' is the master data file ######################
dfCountry <- read_excel("Data/00C2_country_region.xlsx",
sheet="_00C2_country_region")
#######  read data here ####################################
####### 'df1' is the master data file ######################
df1 <- read_excel("Data/00C1_Export_all_sorted.xlsx",
sheet="_00C1_Export_all_sorted")
###### keep rows with both CBR and CDR values ###############
df1 <- subset(df1, (!is.na(df1$CBR) & !is.na(df1$CDR)) )
df1 <- df1 %>% rename( year = Year)
##########----------------------------------------#############
##########   loop on countries                    #############
for (selCountry in c("Sweden","Taiwan") ) {
######### output location #################
fileNm <- "SwedenPlots3"
pngFile <- paste("Output/", fileNm, ".png", sep="")
png(pngFile, width = 600, height = 600, units = "px")
#####for (selCountry in unique(dfCountry$Country) ) {
selRegion <-  dfCountry[dfCountry$Country==selCountry, 4 ]
selSubRegion <-  dfCountry[dfCountry$Country==selCountry, 6 ]
selTitle <- paste(selRegion, selSubRegion, selCountry, sep=" - ")
cat(selTitle, "%%%%%%%%%%")
########## 'df2' holds one country at a time ##########
########## RNI and moving averages added  ###################
df2 <- df1[df1$Country==selCountry ,c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ) ] %>%
mutate(RNI = CBR - CDR,
RNI_11 = rollmean(RNI, k=11, fill=NA, align='center'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='center'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='center')
) %>%  arrange(year)
########  call runSegs function ##############################
runSegs()
}
####### end selCountry loop ################
####### close PDF file
dev.off()
#####  save dfOut dataframe of statistics to disk  ##########
save(dfOut, file='Data/dfOut_3.rdata')
#####  save df3 dataframe of observed and predicted to disk  ##########
save(df3, file='Data/dfPred3.rdata')
graphics.off()
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
#######  read country-region list here ####################################
####### 'df1' is the master data file ######################
dfCountry <- read_excel("Data/00C2_country_region.xlsx",
sheet="_00C2_country_region")
#######  read data here ####################################
####### 'df1' is the master data file ######################
df1 <- read_excel("Data/00C1_Export_all_sorted.xlsx",
sheet="_00C1_Export_all_sorted")
###### keep rows with both CBR and CDR values ###############
df1 <- subset(df1, (!is.na(df1$CBR) & !is.na(df1$CDR)) )
df1 <- df1 %>% rename( year = Year)
##########----------------------------------------#############
##########   loop on countries                    #############
for (selCountry in c("Sweden","Taiwan") ) {
######### output location #################
#  fileNm <- "SwedenPlots3"
pngFile <- paste("Output/", selCountry, "Plots.png", sep="")
png(pngFile, width = 600, height = 600, units = "px")
#####for (selCountry in unique(dfCountry$Country) ) {
selRegion <-  dfCountry[dfCountry$Country==selCountry, 4 ]
selSubRegion <-  dfCountry[dfCountry$Country==selCountry, 6 ]
selTitle <- paste(selRegion, selSubRegion, selCountry, sep=" - ")
cat(selTitle, "%%%%%%%%%%")
########## 'df2' holds one country at a time ##########
########## RNI and moving averages added  ###################
df2 <- df1[df1$Country==selCountry ,c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ) ] %>%
mutate(RNI = CBR - CDR,
RNI_11 = rollmean(RNI, k=11, fill=NA, align='center'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='center'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='center')
) %>%  arrange(year)
########  call runSegs function ##############################
runSegs()
}
####### end selCountry loop ################
####### close PDF file
dev.off()
#####  save dfOut dataframe of statistics to disk  ##########
save(dfOut, file='Data/dfOut_3.rdata')
#####  save df3 dataframe of observed and predicted to disk  ##########
save(df3, file='Data/dfPred3.rdata')
graphics.off()
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
#######  read country-region list here ####################################
####### 'df1' is the master data file ######################
dfCountry <- read_excel("Data/00C2_country_region.xlsx",
sheet="_00C2_country_region")
#######  read data here ####################################
####### 'df1' is the master data file ######################
df1 <- read_excel("Data/00C1_Export_all_sorted.xlsx",
sheet="_00C1_Export_all_sorted")
###### keep rows with both CBR and CDR values ###############
df1 <- subset(df1, (!is.na(df1$CBR) & !is.na(df1$CDR)) )
df1 <- df1 %>% rename( year = Year)
##########----------------------------------------#############
##########   loop on countries                    #############
for (selCountry in c("Sweden","Taiwan") ) {
######### output location #################
#  fileNm <- "SwedenPlots3"
pngFile <- paste("Output/", selCountry, "Plots.png", sep="")
png(pngFile, width = 600, height = 600, units = "px")
#####for (selCountry in unique(dfCountry$Country) ) {
selRegion <-  dfCountry[dfCountry$Country==selCountry, 4 ]
selSubRegion <-  dfCountry[dfCountry$Country==selCountry, 6 ]
selTitle <- paste(selRegion, selSubRegion, selCountry, sep=" - ")
cat(selTitle, "%%%%%%%%%%")
########## 'df2' holds one country at a time ##########
########## RNI and moving averages added  ###################
df2 <- df1[df1$Country==selCountry ,c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ) ] %>%
mutate(RNI = CBR - CDR,
RNI_11 = rollmean(RNI, k=11, fill=NA, align='center'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='center'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='center')
) %>%  arrange(year)
########  call runSegs function ##############################
runSegs(1725, 2025)
}
dev.off()
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
#######  read country-region list here ####################################
####### 'df1' is the master data file ######################
dfCountry <- read_excel("Data/00C2_country_region.xlsx",
sheet="_00C2_country_region")
#######  read data here ####################################
####### 'df1' is the master data file ######################
df1 <- read_excel("Data/00C1_Export_all_sorted.xlsx",
sheet="_00C1_Export_all_sorted")
###### keep rows with both CBR and CDR values ###############
df1 <- subset(df1, (!is.na(df1$CBR) & !is.na(df1$CDR)) )
df1 <- df1 %>% rename( year = Year)
##########----------------------------------------#############
##########   loop on countries                    #############
for (selCountry in c("Sweden","Taiwan") ) {
######### output location #################
#  fileNm <- "SwedenPlots3"
pngFile <- paste("Output/", selCountry, "Plots.png", sep="")
png(pngFile, width = 600, height = 600, units = "px")
#####for (selCountry in unique(dfCountry$Country) ) {
selRegion <-  dfCountry[dfCountry$Country==selCountry, 4 ]
selSubRegion <-  dfCountry[dfCountry$Country==selCountry, 6 ]
selTitle <- paste(selRegion, selSubRegion, selCountry, sep=" - ")
cat(selTitle, "%%%%%%%%%%")
########## 'df2' holds one country at a time ##########
########## RNI and moving averages added  ###################
df2 <- df1[df1$Country==selCountry ,c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ) ] %>%
mutate(RNI = CBR - CDR,
RNI_11 = rollmean(RNI, k=11, fill=NA, align='center'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='center'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='center')
) %>%  arrange(year)
########  call runSegs function ##############################
runSegs(1725, 2025)
}
####### end selCountry loop ################
####### close PDF file
dev.off()
#####  save dfOut dataframe of statistics to disk  ##########
save(dfOut, file='Data/dfOut_3.rdata')
#####  save df3 dataframe of observed and predicted to disk  ##########
save(df3, file='Data/dfPred3.rdata')
graphics.off()
graphics.off()
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
#######  read country-region list here ####################################
####### 'df1' is the master data file ######################
dfCountry <- read_excel("Data/00C2_country_region.xlsx",
sheet="_00C2_country_region")
#######  read data here ####################################
####### 'df1' is the master data file ######################
df1 <- read_excel("Data/00C1_Export_all_sorted.xlsx",
sheet="_00C1_Export_all_sorted")
###### keep rows with both CBR and CDR values ###############
df1 <- subset(df1, (!is.na(df1$CBR) & !is.na(df1$CDR)) )
df1 <- df1 %>% rename( year = Year)
##########----------------------------------------#############
##########   loop on countries                    #############
for (selCountry in c("Sweden","Taiwan") ) {
######### output location #################
#  fileNm <- "SwedenPlots3"
pngFile <- paste("Output/", selCountry, "Plots.png", sep="")
png(pngFile, width = 600, height = 600, units = "px")
#####for (selCountry in unique(dfCountry$Country) ) {
selRegion <-  dfCountry[dfCountry$Country==selCountry, 4 ]
selSubRegion <-  dfCountry[dfCountry$Country==selCountry, 6 ]
selTitle <- paste(selRegion, selSubRegion, selCountry, sep=" - ")
cat(selTitle, "%%%%%%%%%%")
########## 'df2' holds one country at a time ##########
########## RNI and moving averages added  ###################
df2 <- df1[df1$Country==selCountry ,c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ) ] %>%
mutate(RNI = CBR - CDR,
RNI_11 = rollmean(RNI, k=11, fill=NA, align='center'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='center'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='center')
) %>%  arrange(year)
########  call runSegs function ##############################
runSegs(1725, 2025)
}
####### end selCountry loop ################
####### close PDF file
dev.off()
#####  save dfOut dataframe of statistics to disk  ##########
save(dfOut, file='Data/dfOut_3.rdata')
#####  save df3 dataframe of observed and predicted to disk  ##########
save(df3, file='Data/dfPred3.rdata')
graphics.off()
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
#######  read country-region list here ####################################
####### 'df1' is the master data file ######################
dfCountry <- read_excel("Data/00C2_country_region.xlsx",
sheet="_00C2_country_region")
#######  read data here ####################################
####### 'df1' is the master data file ######################
df1 <- read_excel("Data/00C1_Export_all_sorted.xlsx",
sheet="_00C1_Export_all_sorted")
###### keep rows with both CBR and CDR values ###############
df1 <- subset(df1, (!is.na(df1$CBR) & !is.na(df1$CDR)) )
df1 <- df1 %>% rename( year = Year)
##########----------------------------------------#############
##########   loop on countries                    #############
for (selCountry in c("Sweden","Taiwan") ) {
######### output location #################
#  fileNm <- "SwedenPlots3"
pngFile <- paste("Output/", selCountry, "Plots.png", sep="")
png(pngFile, width = 600, height = 600, units = "px")
#####for (selCountry in unique(dfCountry$Country) ) {
selRegion <-  dfCountry[dfCountry$Country==selCountry, 4 ]
selSubRegion <-  dfCountry[dfCountry$Country==selCountry, 6 ]
selTitle <- paste(selRegion, selSubRegion, selCountry, sep=" - ")
cat(selTitle, "%%%%%%%%%%")
########## 'df2' holds one country at a time ##########
########## RNI and moving averages added  ###################
df2 <- df1[df1$Country==selCountry ,c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ) ] %>%
mutate(RNI = CBR - CDR,
RNI_11 = rollmean(RNI, k=11, fill=NA, align='center'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='center'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='center')
) %>%  arrange(year)
########  call runSegs function ##############################
runSegs(1725, 2025)
}
####### end selCountry loop ################
####### close PDF file
dev.off()
#####  save dfOut dataframe of statistics to disk  ##########
save(dfOut, file='Data/dfOut_3.rdata')
#####  save df3 dataframe of observed and predicted to disk  ##########
save(df3, file='Data/dfPred3.rdata')
graphics.off()
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
#######  read country-region list here ####################################
####### 'df1' is the master data file ######################
dfCountry <- read_excel("Data/00C2_country_region.xlsx",
sheet="_00C2_country_region")
#######  read data here ####################################
####### 'df1' is the master data file ######################
df1 <- read_excel("Data/00C1_Export_all_sorted.xlsx",
sheet="_00C1_Export_all_sorted")
###### keep rows with both CBR and CDR values ###############
df1 <- subset(df1, (!is.na(df1$CBR) & !is.na(df1$CDR)) )
df1 <- df1 %>% rename( year = Year)
##########----------------------------------------#############
##########   loop on countries                    #############
for (selCountry in c("Sweden","Taiwan") ) {
######### output location #################
#  fileNm <- "SwedenPlots3"
pngFile <- paste("Output/", selCountry, "Plots.png", sep="")
png(pngFile, width = 600, height = 600, units = "px")
#####for (selCountry in unique(dfCountry$Country) ) {
selRegion <-  dfCountry[dfCountry$Country==selCountry, 4 ]
selSubRegion <-  dfCountry[dfCountry$Country==selCountry, 6 ]
selTitle <- paste(selRegion, selSubRegion, selCountry, sep=" - ")
cat(selTitle, "%%%%%%%%%%")
########## 'df2' holds one country at a time ##########
########## RNI and moving averages added  ###################
df2 <- df1[df1$Country==selCountry ,c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ) ] %>%
mutate(RNI = CBR - CDR,
RNI_11 = rollmean(RNI, k=11, fill=NA, align='center'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='center'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='center')
) %>%  arrange(year)
########  call runSegs function ##############################
runSegs(1725, 2025)
}
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
library("readxl")
library("tidyr")
library("xlsx")
setwd("C:/Users/altergc/Documents/Historical Demography/Handbook/DT_git/DemoTran")
###### call runSegs.R to set up function that computes segments and stats #########
source("Rcode/runSegs.R")
#######  read country-region list here ####################################
####### 'df1' is the master data file ######################
dfCountry <- read_excel("Data/00C2_country_region.xlsx",
sheet="_00C2_country_region")
#######  read data here ####################################
####### 'df1' is the master data file ######################
df1 <- read_excel("Data/00C1_Export_all_sorted.xlsx",
sheet="_00C1_Export_all_sorted")
###### keep rows with both CBR and CDR values ###############
df1 <- subset(df1, (!is.na(df1$CBR) & !is.na(df1$CDR)) )
df1 <- df1 %>% rename( year = Year)
##########----------------------------------------#############
##########   loop on countries                    #############
for (selCountry in c("Sweden","Taiwan") ) {
######### output location #################
#  fileNm <- "SwedenPlots3"
pngFile <- paste("Output/", selCountry, "Plots.png", sep="")
png(pngFile, width = 600, height = 600, units = "px")
#####for (selCountry in unique(dfCountry$Country) ) {
selRegion <-  dfCountry[dfCountry$Country==selCountry, 4 ]
selSubRegion <-  dfCountry[dfCountry$Country==selCountry, 6 ]
selTitle <- paste(selRegion, selSubRegion, selCountry, sep=" - ")
cat(selTitle, "%%%%%%%%%%")
########## 'df2' holds one country at a time ##########
########## RNI and moving averages added  ###################
df2 <- df1[df1$Country==selCountry ,c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ) ] %>%
mutate(RNI = CBR - CDR,
RNI_11 = rollmean(RNI, k=11, fill=NA, align='center'),
CBR_MAV = rollmean(CBR, k=11, fill=NA, align='center'),
CDR_MAV = rollmean(CDR, k=11, fill=NA, align='center')
) %>%  arrange(year)
########  call runSegs function ##############################
runSegs(1725, 2025)
}
####### end selCountry loop ################
####### close PDF file
dev.off()
#####  save dfOut dataframe of statistics to disk  ##########
save(dfOut, file='Data/dfOut_3.rdata')
#####  save df3 dataframe of observed and predicted to disk  ##########
save(df3, file='Data/dfPred3.rdata')
graphics.off()
